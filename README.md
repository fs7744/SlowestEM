# SlowestEM

Just try use SourceGenerator can be fastest db data mapping to object ?

And it can't do when what code ?

## no generate code when

- Generic Type      (can not handle T if no use emit)
- Anonymous Type    (SourceGenerator can not find anonymous type)

## generate code

``` csharp

// <auto-generated/>
#pragma warning disable 8019 //disable 'unnecessary using directive' warning
using System;
using System.Data;
using System.Runtime.CompilerServices;
using System.Collections.Generic;

namespace SlowestEM.Generator
{
    public static partial class Dog_Accessors
    {
        public static IEnumerable<BenchmarkTest.Dog> Read(IDataReader reader)
        {
            var s = new List<Action<BenchmarkTest.Dog, IDataReader>>(reader.FieldCount);
            for (int i = 0; i < reader.FieldCount; i++)
            {
                var j = i;
                switch (reader.GetName(j).ToLower())
                {
                    
                    case "age": 
                    {
                        // int?
                        
                        var needConvert = typeof(int) != reader.GetFieldType(i);
                        s.Add((d,r) => d.Age = DBExtensions.ReadToInt32Nullable(r,j,needConvert));
                         
                    }
                    break;
                    case "name": 
                    {
                        // string
                        
                        var needConvert = typeof(string) != reader.GetFieldType(i);
                        s.Add((d,r) => d.Name = DBExtensions.ReadToString(r,j,needConvert));
                         
                    }
                    break;
                    case "weight": 
                    {
                        // float?
                        
                        var needConvert = typeof(float) != reader.GetFieldType(i);
                        s.Add((d,r) => d.Weight = DBExtensions.ReadToFloatNullable(r,j,needConvert));
                         
                    }
                    break;
                    default:
                        break;
                }
            }
            while (reader.Read())
            {
                var d = new BenchmarkTest.Dog();
                foreach (var item in s)
                {
                    item?.Invoke(d,reader);
                }
                yield return d;
            }
        }
    }
}
            
```

## test

```

BenchmarkDotNet v0.13.12, Windows 11 (10.0.22631.3880/23H2/2023Update/SunValley3)
13th Gen Intel Core i9-13900KF, 1 CPU, 32 logical and 24 physical cores
.NET SDK 9.0.100-preview.6.24328.19
  [Host]     : .NET 8.0.7 (8.0.724.31311), X64 RyuJIT AVX2
  DefaultJob : .NET 8.0.7 (8.0.724.31311), X64 RyuJIT AVX2


```
| Method                      | Categories | Mean        | Error     | StdDev    | Ratio | RatioSD | Gen0   | Gen1   | Allocated | Alloc Ratio |
|---------------------------- |----------- |------------:|----------:|----------:|------:|--------:|-------:|-------:|----------:|------------:|
| SetClassFirst               | 1          |    242.8 ns |   4.81 ns |   4.94 ns |  1.00 |    0.00 | 0.0148 | 0.0143 |     280 B |        1.00 |
| SourceGeneratorMappingFirst | 1          |    299.1 ns |   5.95 ns |  11.47 ns |  1.21 |    0.05 | 0.0272 | 0.0267 |     512 B |        1.83 |
| DapperMappingFirst          | 1          |    503.5 ns |   3.98 ns |   3.53 ns |  2.08 |    0.04 | 0.0219 |      - |     416 B |        1.49 |
|                             |            |             |           |           |       |         |        |        |           |             |
| SetClass                    | 1000       |  4,606.3 ns |  75.19 ns |  70.34 ns |  1.00 |    0.00 | 3.0136 | 0.9995 |   56840 B |        1.00 |
| SourceGeneratorMapping      | 1000       | 12,312.9 ns | 213.70 ns | 199.89 ns |  2.67 |    0.07 | 3.0212 | 0.9918 |   57072 B |        1.00 |
| DapperMapping               | 1000       | 30,458.6 ns | 156.51 ns | 130.69 ns |  6.62 |    0.11 | 5.5542 | 0.9155 |  105120 B |        1.85 |
