using Microsoft.CodeAnalysis;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace SlowestEM.Generator
{
    [Generator]
    public class ReaderToEntitySourceGenerator : ISourceGenerator
    {
        private Dictionary<string,string> supportReaderFieldType = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase) 
        { 
            {"string","ReadToString" },
            {"short","ReadToInt16" },
            {"short?","ReadToInt16Nullable" },
            {"ushort","ReadToUInt16" },
            {"ushort?","ReadToUInt16Nullable" },
            {"int","ReadToInt32" },
            {"int?","ReadToInt32Nullable" },
            {"uint","ReadToUInt32" },
            {"uint?","ReadToUInt32Nullable" },
            {"long","ReadToInt64" },
            {"long?","ReadToInt64Nullable" },
            {"ulong","ReadToUInt64" },
            {"ulong?","ReadToUInt64Nullable" },
            {"float","ReadToFloat" },
            {"float?","ReadToFloatNullable" },
            {"double","ReadToDouble" },
            {"double?","ReadToDoubleNullable" },
            {"decimal","ReadToDecimal" },
            {"decimal?","ReadToDecimalNullable" },
            {"bool","ReadToBoolean" },
            {"bool?","ReadToBooleanNullable" },
            {"char","ReadToChar" },
            {"char?","ReadToCharNullable" },
            {"byte","ReadToByte" },
            {"byte?","ReadToByteNullable" },
            {"DateTime","ReadToDateTime" },
            {"DateTime?","ReadToDateTimeNullable" },
        };

        private Dictionary<string, string> supportParamFieldType = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            {"string","DbType.String" },
            {"short","DbType.Int16" },
            {"short?","DbType.Int16" },
            {"ushort","DbType.UInt16" },
            {"ushort?","DbType.UInt16" },
            {"int","DbType.Int32" },
            {"int?","DbType.Int32" },
            {"uint","DbType.UInt32" },
            {"uint?","DbType.UInt32" },
            {"long","DbType.Int64" },
            {"long?","DbType.Int64" },
            {"ulong","DbType.UInt64" },
            {"ulong?","DbType.UInt64" },
            {"float","DbType.Single" },
            {"float?","DbType.Single" },
            {"double","DbType.Double" },
            {"double?","DbType.Double" },
            {"decimal","DbType.Decimal" },
            {"decimal?","DbType.Decimal" },
            {"bool","DbType.Boolean" },
            {"bool?","DbType.Boolean" },
            {"char","DbType.String" },
            {"char?","DbType.String" },
            {"byte","DbType.Byte" },
            {"byte?","DbType.Byte" },
            {"DateTime","DbType.DateTime" },
            {"DateTime?","DbType.DateTime" },
        };
        
        public void Execute(GeneratorExecutionContext context)
        {
            var finder = context.SyntaxContextReceiver as FindClassReceiver;
            var cList = new StringBuilder();
            foreach (var namedType in finder.AllClass(context))
            {
                if (namedType.IsAbstract || namedType.IsGenericType)
                    continue;
                GenerateClassMapper(context, cList, namedType);
            }

            GenerateEnableFunc(context, cList);
        }

        private void GenerateClassMapper(GeneratorExecutionContext context, StringBuilder cList, INamedTypeSymbol namedType)
        {
            var ps = namedType.GetAllSettableProperties().Where(i => supportReaderFieldType.ContainsKey(i.Type.ToRealTypeDisplayString()) || i.Type.IsEnum()).ToList();
            var rs = namedType.GetAllGettableProperties().Where( i => !i.HasAttribute("NotDbParameterAttribute")).Where(i => supportParamFieldType.ContainsKey(i.Type.ToRealTypeDisplayString())).ToList();
            var fullName = namedType.ToDisplayString();
            var src = $@"
// <auto-generated/>
#pragma warning disable 8019 //disable 'unnecessary using directive' warning
using System;
using System.Data;
using System.Runtime.CompilerServices;
using System.Collections.Generic;

namespace SlowestEM.Generator
{{
    public static partial class {namedType.Name}_Accessors
    {{
        {namedType.DeclaredAccessibility.ToDisplayString()} static IEnumerable<{fullName}> Read(IDataReader reader)
        {{
            var s = new List<Action<{fullName}, IDataReader>>(reader.FieldCount);
            for (int i = 0; i < reader.FieldCount; i++)
            {{
                var j = i;
                switch (reader.GetName(j).ToLower())
                {{
                    {string.Join("", ps.Select(i => 
                                         {
                                             return $@"
                    case ""{i.Name.ToLower()}"": 
                    {{
                        // {i.Type.ToDisplayString()}
                        {(i.Type.IsEnum() 
                        ? $@"
                        s.Add((d,r) => d.{i.Name} = DBExtensions.{(i.Type.IsNullable() ? "ReadToEnumNullable" : "ReadToEnum")}<{i.Type.ToNoNullableDisplayString()}>(r,j));"
                        : $@"
                        var needConvert = typeof({(i.Type.ToNoNullableDisplayString())}) != reader.GetFieldType(i);
                        s.Add((d,r) => d.{i.Name} = DBExtensions.{supportReaderFieldType[i.Type.ToRealTypeDisplayString()]}(r,j,needConvert));")}
                         
                    }}
                    break;";
                                         }))}
                    default:
                        break;
                }}
            }}
            while (reader.Read())
            {{
                var d = new {fullName}();
                foreach (var item in s)
                {{
                    item?.Invoke(d,reader);
                }}
                yield return d;
            }}
        }}

        {namedType.DeclaredAccessibility.ToDisplayString()} static void CreateParams(IDbCommand command, object oo)
        {{
            var o = ({fullName})oo;
            IDbDataParameter p = null;
            {string.Join("", rs.Select(i => $@"
            p = command.CreateParameter();
            p.ParameterName = ""{i.Name}"";
            p.DbType = {supportParamFieldType[i.Type.ToRealTypeDisplayString()]};
            p.Direction = ParameterDirection.Input;
            p.Value = {(i.Type.IsNullable() ? $"o.{i.Name}.HasValue ? o.{i.Name}.Value : null" : $"o.{i.Name}")};
            command.Parameters.Add(p);
"))}
        }}
    }}
}}
            ";
            context.AddSource($"{fullName}_Accessors.g.cs", src);
            cList.AppendLine($"DBExtensions.ReaderCache[typeof({fullName})] = {namedType.Name}_Accessors.Read;");
            cList.AppendLine($"DBExtensions.ParamCache[typeof({fullName})] = {namedType.Name}_Accessors.CreateParams;");
        }

        private static void GenerateEnableFunc(GeneratorExecutionContext context, StringBuilder cList)
        {
            var generatorSrc = $@"
// <auto-generated/>
#pragma warning disable 8019 //disable 'unnecessary using directive' warning
using System;
using SlowestEM;

namespace SlowestEM.Generator
{{
    public static partial class EntitiesGenerator
    {{
        public static void Enable()
        {{
            {cList}
        }}
    }}
}}
";

            context.AddSource($"SlowestEM.Generator.EntitiesGenerator.g.cs", generatorSrc);
        }

        public void Initialize(GeneratorInitializationContext context)
        {
            context.RegisterForSyntaxNotifications(() => new FindClassReceiver());
        }
    }
}
